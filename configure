#!/bin/sh
config="$@"

prefix_default="/usr/local"
cc_default="gcc"
builddir_default="$(pwd)/build"

teststreams_dir_default="./CI/test_bitstreams"

debug_cflags="-O0 -g -Wall --pedantic"
release_cflags="-O3 -Wall"

cflags_olevel="-O3"
cflags_warnings="-Wall"
cflags_error=
cflags_default="${cflags_warnings} ${cflags_olevel}"

show_help() {
    cat <<EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]

Options:
  --prefix=PREFIX          install in PREFIX [$prefix_default]
  --libdir=LIBDIR          install library in LIBDIR [PREFIX/lib]
  --includedir=DIR         install includes in DIR [PREFIX/include]
  --pkgconfigdir=DIR       install pkg-config files in DIR [LIBDIR/pkgconfig]
  --build-dir=DIR          build objects in DIR [$builddir_default]

  --help                   print this message


  --disable-static         do not build static libraries [no]
  --enable-shared          build shared libraries [no]

  --cc=CC                  select compiler [$cc_default]
  --arch=ARCH              select architecture [$arch]
  --target-os=OS           compiler targets OS [$target_os]

  --cross-prefix=PREFIX    use PREFIX for compilation tools [$cross_prefix]
  --enable-cross-compile   assume a cross-compiler is used

  --cflags=CFLAGS          use CFLAGS as compiler flags [$cflags_default]
  --release                use specific release compiler flags [CFLAGS ${release_cflags}]
  --debug                  use specific debug compiler cflags [CFLAGS ${debug_cflags}]

  --teststreams-dir=DIR    read test bitstreams from DIR[$teststream_dir_default]
EOF
  exit 0
}

# Set default values
prefix=$prefix_default
libdir='${prefix}/lib'
includedir='${prefix}/include'
pkgconfigdir='${libdir}/pkgconfig'

build_dir=$builddir_default
teststreams_dir=$teststreams_dir_default

cc=$cc_default
arch="$(uname -m)"
target_os="$(uname -s)"



# Override values set by user
for opt do
    optval="${opt#*=}"
    case "$opt" in
        --help|-h) show_help
        ;;
        --release)
            cflags="${cflags} ${release_cflags}"
        ;;
        --debug)
            cflags="${cflags} ${debug_cflags}"
        ;;
        *)
            optname="${opt%%=*}"
            optname="${optname#--}"
            optname=$(echo "$optname" | sed 's/-/_/g')
            eval $optname='$optval'
        ;;
    esac
done

if [ -z "$cflags" ] ; then
    cflags="$cflags_default"
fi

# Select arch var according to common arch names
case "$arch" in
    arm*)
        arch="arm"
    ;;
    i[3-6]86*|x86_64|x86_32|amd64)
        arch="x86"
    ;;
		*)
		echo "Unsupported archictecture $arch"
		exit 1.
		;;
esac

case $target_os in
    *win32|*win64)
    shlib_suffix=".dll"
    stlib_suffix=".lib"
    ;;
    *)
    shlib_suffix=".so"
    stlib_suffix=".a"
    # Append PIC flag for shared lib
    cflags="${cflags} -fPIC"
    ;;
esac

cc="${cross_prefix}${cc}"
ar="${cross_prefix}ar"
ranlib="${cross_prefix}ranlib"


cat > config.mak <<EOF
OVVC_CONFIG="${config}"
CC=${cc}
AR=${ar}
RANLIB=${ranlib}
ARCH=${arch}
CFLAGS=${cflags}
SSE_CFLAGS= -mssse3
SHARED_LIBSUFF:=${shlib_suffix}
STATIC_LIBSUFF:=${stlib_suffix}
BUILDDIR=${build_dir}

TESTSTREAMSDIR=$teststreams_dir_default

INSTALL_PREFIX=${prefix}
INSTALL_LIB=\$(INSTALL_PREFIX)/lib/libopenvvc
INSTALL_INCLUDE=\$(INSTALL_PREFIX)/include/libopenvvc
INSTALL_PKGCONFIG=\$(INSTALL_PREFIX)/lib/pkgconfig
INSTALL_BIN=\$(INSTALL_PREFIX)/bin
EOF

cat > config.sh <<EOF
INSTALL_PREFIX=${prefix}
INSTALL_LIB=\${INSTALL_PREFIX}/lib/libopenvvc
INSTALL_INCLUDE=\${INSTALL_PREFIX}/include/libopenvvc
INSTALL_PKGCONFIG=\${INSTALL_PREFIX}/lib/pkgconfig
INSTALL_BIN=\${INSTALL_PREFIX}/bin
EOF

exit 0
